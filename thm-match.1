.\" Generated by pandoc and edited by hand.
.TH THM-MATCH "1" "October 2025" "thm-match 0.30" "User Commands"
.SH NAME
thm-match \- a system for identifying duplicate images
.SH SYNOPSIS
tmatch
[\fI\,-dimvVz\/\fR] \fI\,searchlist\/\fR
\fI\,database\/\fR
.PP
tfind
[\fI\,-drstvV\/\fR] [\fI\,dataset\/\fR]
.PP
tprint
[\fI\,-tvV\/\fR] \fI\,image\/\fR
.PP
tdiff
[\fI\,-6dvV\/\fR] \fI\,imageA\/\fR
\fI\,imageB\/\fR
.PP
tupdate
[\fI\,-dfiUvVx\/\fR] \fI\,database\/\fR [\fI\,\-o update-file\/\fR]
.PP
tdup
[\fI\,-dmuvVz\/\fR] [\fI\,-fFlLnNoO\/\fR] \fI\,dataset\/\fR
.PP
tcheck
[\fI\,-V\/\fR] \fI\,search-file\/\fR
[\fI\,\-d database-file\/\fR]
.SH DESCRIPTION
\fBthm-match\fR uses ImageMagic to create thumbnails and thumbprints of images to find
duplicates and create databases of images for later searches.
.SS smatch
Compares two databases \- a \fIsearchlist\fR and a
\fIdatabase\fR, printing the filepaths of matching files from the
\fIsearchlist\fR to \fIstdout\fR.
.TP
\fB-d\fR
Print matches from the \fIdatabase\fR.
.TP
\fB-i\fR
Print the complement of the search - the files that \fBdon\[cq]t\fR
match.
This output is the full two or three field entries for the files from the \fIdatabase\fR
dataset.
.TP
\fB-m\fR
Print all matches for a file if there are multiples.
.TP
\fB-V\fR
Print version information.
.SS tfind
This generates a database for the current directory, optionally writing thumbnail files in a
sub-directory.
.TP
\fB-d\fR
Don't sort output.
.TP
\fB-n\fR
Suppress progress in thumbnail generation phase.
.TP
\fB-r\fR
Recurse directories.  The default is to just process the current directory.
.TP
\fB-s\fR
Suppress most messages and print to stdout.
Don\[cq]t create an output file.
Default behaviour if no filename given.
.TP
\fB-t\fR
Save thumbnail file in subdirectory.
.TP
\fB-v\fR
Verbose.
Print lots of stuff.
.TP
\fB-V\fR
Print version information.
.PP
.SS tprint
Generate a thumbnail for a single image and print a thumbprint entry for it, optionally writing  the thumbnail in a sub-directory.
.TP
\fB-t\fR
Save thumbnail file in subdirectory.
.TP
\fB-v\fR
Verbose.
Print lots of stuff.
.TP
\fB-V\fR
Print version information.
.PP
.SS supdate
This generates an update to an existing dataset for the current directory,
rather than re-calculating all SHA256SUMs from scratch.
By default it produces a report on changes without calculating checksums
or writing results to an s2db file.
.TP
\fB-d\fR
Show which entries will be removed from the database by the update.
.TP
\fB-f\fR
Force supdate to write the output file.  By default, if there are a lot of
changes (90+% files deleted or 10-% retained) supdate issues a warning and
suppresses writing the output file.
.TP
\fB-i\fR
\fBInclude\fR only entries in 'sf_filter' in file search.
.TP
\fB-o update-file\fR
Write updated database to specified file.  \fB-U\fR is implied.
.TP
\fB-U\fR
Write an updated database file.  Appends '-U' to existing database name.
.TP
\fB-v\fR
Verbose.  Print lots of stuff.
.TP
\fB-V\fR
Print version information.
.TP
\fB-x\fR
\fBExclude\fR entries in 'sf_filter' from file search.
.PP
.SS sdup
Searches for duplicate files within a dataset.  By default it prints a report with the first duplicate in each set highlighted in yellow. The switches \fBfFlL\fR and \fBnNoO\fR can be used to choose which combination of duplicates is printed.  It's best to use this on a dataset freshly built with \fBsfind\fR - using \fBsdup\fR with datasets modified by \fBsupdate\fR can produce unreliable results.
.TP
\fB-d\fR
Don\[cq]t print the dataset column.
.TP
\fB-m\fR
Mark the first duplicate with a hash (#).  The default is to print it in yellow using ANSI colour codes that can interfere with output piped to another command.
.TP
\fB-u\fR
Print all unique entries according to their SHA256SUMs in s2db format.  This will include all files with zero size if any are present.
.TP
\fB-v\fR
Verbose.  Print lots of stuff.
.TP
\fB-V\fR
Print version information.
.TP
\fB-z\fR
Include files with zero file size.  Suppressed by default.
.TP
The following options are used to choose which of the duplicates to \fBKEEP\fR.  Only one can be used at a time.  It will print a list of the files to be discarded after keeping the specified choice.
.TP
.TQ
\fB-f -F -l -L\fR are based on the alphabetical order of the files.
.IP
\fB-f\fR   Print \fBall but\fR the \fBfirst\fR duplicate in each set.  This is the safest option, and the default if more than one alphabetical choice is given.
.IP
\fB-F\fR   Print \fBonly\fR the \fBfirst\fR duplicate in each set.
.IP
\fB-l\fR   Print \fBall but\fR the \fBlast\fR duplicate in each set
.IP
\fB-L\fR   Print \fBonly\fR the \fBlast\fR duplicate in each set.
.TP
\fB-n -N -o -O\fR are based on the timestamps of files.  In order for these choices to work the files need to be in place.
.IP
\fB-n\fR   Print \fBall but\fR the \fBnewest\fR duplicate in each set.  This is the default if more than one timestamp choice is given.
.IP
\fB-N\fR   Print \fBonly\fR the \fBnewest\fR duplicate in each set.
.IP
\fB-o\fR   Print \fBall but\fR the \fBoldest\fR duplicate in each set
.IP
\fB-O\fR   Print \fBonly\fR the \fBoldest\fR duplicate in each set.

.SS scheck
\fIscheck\fR searches for a single file in a database.  If no database is specified,
the last verified database is used.
.TP
\fB-d database-file\fR
Specify the database to search.  Databases should given with a full pathname to avoid 'not found' errors when the CWD changes.
.TP
\fB-V\fR
Print version information.
.PP
.SH THUMBPRINTS
.PP
Thumbprints consist of four fields: 1, the greyprint; 2, the hueprint; 3, the image magnitude; 4, the image name with full path.
.TP
The thumbnail of an image is divided into quadrants, and each quadrant has its average grey and hue values calculated.  The number of pixels in the original image is recorded as a magnitude in a single base 64 character.
eg. vyBK cZIE V
.PP
.TS
left;
L L.
 _______________
|       |       |    0 1 2 3 4 5 6 7
|       |       |    8 9 a b c d e f
|       |       |    g h i j k l m n
|_______|_______|    o p q r s t u v
|       |       |    w x y z A B C D
|       |       |    E F G H I J L K
|       |       |    M N O P Q R S T
|_______|_______|    U V W X Y Z - +

Average greyscale and hue of quadrants
in 6 bit expressed as base 64 characters
.TE
.PP
.SH FILES
.TP
image.png.rgb
Thumbnail file generated by ImageMagic.  It is an image reduced to fit in a 64x64 pixel square,
with mid-grey padding and rendered as rgb in 6 bits per channel.
.TP
database.tpdb
A database of thumbprints.
.PP
.SH RESTRICTIONS
.PP
The sorts used in \fItmatch\fR, \fItfind\fR and \fIsupdate\fR are very basic and slow.  If you\[cq]re generating a large dataset with \fIsfind\fR you\[cq]d be better off
leaving the output unsorted and piping it to \fIsort (1)\fR.
.SH DEPENDENCIES
.PP
\fItfind\fR and others use popen() to get thumbnail images from ImageMagick.
.SH BUGS
.PP
Doesn\[cq]t use zero-delimited file names, so is subject to errors caused by strange characters in file names, especially '\[ga]'.
.SH COPYLEFT
.PP
If you want to steal this, I'll meet you in the carpark.
.SH AUTHOR
.PP
Bob Hayward (Zax) zx81\[at]zx81.nz
